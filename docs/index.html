<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suite Mate Survey</title>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4d;
      --text: #e6edf3;
      --muted: #8b9cb3;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --accent-active: #388bfd;
      --danger: #f85149;
      --success: #3fb950;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 16px;
      line-height: 1.5;
      min-height: 100vh;
    }
    .container { max-width: 560px; margin: 0 auto; }
    h1 { font-size: 1.5rem; margin: 0 0 8px; }
    .subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 24px; }
    fieldset {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 20px;
      background: var(--surface);
    }
    legend { font-weight: 600; padding: 0 8px; margin-bottom: 4px; }
    .field-label { color: var(--muted); font-size: 0.9rem; margin-bottom: 10px; display: block; }
    .hint { font-size: 0.85rem; color: var(--muted); margin-top: 8px; }

    /* Button grid (name, suite preference) */
    .btn-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }
    .btn-option {
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .btn-option:hover { border-color: var(--muted); background: #252d3a; }
    .btn-option.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent);
    }

    /* Suite preference: 5 options in a row */
    .suite-row { display: flex; flex-wrap: wrap; gap: 8px; }
    .suite-row .btn-option { flex: 1; min-width: 0; }

    /* Top 5: fixed row of buttons, click to set order (1–5), click again to remove */
    .top5-pool {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .top5-pool .btn-option .rank-badge {
      display: inline-block;
      min-width: 18px;
      height: 18px;
      line-height: 18px;
      margin-left: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
      text-align: center;
    }
    .top5-pool .btn-option.selected { border-color: var(--accent); background: rgba(88, 166, 255, 0.15); color: var(--accent); }
    .top5-order-hint { font-size: 0.9rem; color: var(--muted); margin: 8px 0 0; min-height: 1.4em; }

    /* Prefer NOT: fixed row of buttons, click to toggle */
    .conflict-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .conflict-grid .btn-option.selected { border-color: var(--danger); background: rgba(248, 81, 73, 0.12); color: #f85149; }

    /* Sliders */
    .slider-block { margin-bottom: 20px; }
    .slider-block:last-child { margin-bottom: 0; }
    .slider-label { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; color: var(--muted); }
    input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--border);
      border-radius: 4px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
    }

    /* Submit */
    .btn-submit {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .btn-submit:hover { background: var(--accent-hover); }

    /* Result */
    #result { display: none; margin-top: 24px; }
    #result.show { display: block; }
    #result pre {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
      font-size: 0.8rem;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .result-actions { display: flex; gap: 10px; margin-top: 12px; }
    .result-actions button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    .thank-you { color: var(--success); font-weight: 600; margin-bottom: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Suite Mate Survey</h1>
    <p class="subtitle">6-person suite + 4-person suite. Your answers help us create fair, compatible groups.</p>

    <form id="survey">
      <fieldset>
        <legend>1. Your name</legend>
        <div class="btn-grid" id="nameGrid" role="group" aria-label="Select your name"></div>
        <input type="hidden" id="name" required>
      </fieldset>

      <fieldset>
        <legend>2. Suite size preference</legend>
        <span class="field-label">Rate how strongly you prefer each (1 = not at all, 5 = strongly prefer).</span>
        <div class="slider-block">
          <div class="slider-label"><span>6-person suite</span><span id="prefer6Val">3</span></div>
          <input type="range" id="prefer6" min="1" max="5" value="3" step="1">
        </div>
        <div class="slider-block">
          <div class="slider-label"><span>4-person suite</span><span id="prefer4Val">3</span></div>
          <input type="range" id="prefer4" min="1" max="5" value="3" step="1">
        </div>
      </fieldset>

      <fieldset>
        <legend>3. Top 5 suitemates</legend>
        <span class="field-label">Click names in the order you want (1st click = #1, 2nd = #2, … up to 5). Click again to remove.</span>
        <div class="top5-pool" id="top5Pool"></div>
        <p class="top5-order-hint" id="top5OrderHint">Select your name above first.</p>
      </fieldset>

      <fieldset>
        <legend>4. Prefer NOT to be with</legend>
        <span class="field-label">Select anyone you’d rather not be in the same suite with (optional). Click again to clear.</span>
        <div class="conflict-grid" id="conflictGrid"></div>
      </fieldset>

      <button type="submit" class="btn-submit">Submit survey</button>
    </form>

    <div id="result">
      <p class="thank-you">Thanks! Send your response to the group organizer.</p>
      <pre id="jsonOut"></pre>
      <div class="result-actions">
        <button type="button" id="copyBtn">Copy to clipboard</button>
        <button type="button" id="downloadBtn">Download .json</button>
      </div>
    </div>
  </div>

  <script>
    const PEOPLE = ['Derek', 'Michael', 'Raiymbek', 'Aryan', 'Ethan', 'Bill', 'Kat', 'Elson', 'Luke', 'Victor'];

    // Supabase: set these to save responses to your database (see SUPABASE_SETUP.md)
    const SUPABASE_URL = '';
    const SUPABASE_ANON_KEY = '';

    // 1. Name buttons
    const nameGrid = document.getElementById('nameGrid');
    const nameInput = document.getElementById('name');
    PEOPLE.forEach(name => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn-option';
      btn.textContent = name;
      btn.dataset.value = name;
      btn.addEventListener('click', () => {
        nameGrid.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        nameInput.value = name;
        updateTop5Pool();
        updateConflictGrid();
      });
      nameGrid.appendChild(btn);
    });

    // 2. Suite preference sliders (1–5 each)
    document.getElementById('prefer6').addEventListener('input', e => {
      document.getElementById('prefer6Val').textContent = e.target.value;
    });
    document.getElementById('prefer4').addEventListener('input', e => {
      document.getElementById('prefer4Val').textContent = e.target.value;
    });

    // 3. Top 5: fixed buttons, click to add in order (1–5), click again to remove
    let top5Order = [];
    const top5Pool = document.getElementById('top5Pool');
    const top5OrderHint = document.getElementById('top5OrderHint');

    function refreshTop5Buttons() {
      const self = nameInput.value;
      if (!self) return;
      const others = PEOPLE.filter(p => p !== self);
      top5Pool.querySelectorAll('.btn-option').forEach(btn => {
        const name = btn.dataset.name;
        const rank = top5Order.indexOf(name) + 1;
        const selected = rank > 0;
        btn.classList.toggle('selected', selected);
        btn.innerHTML = name + (selected ? '<span class="rank-badge">' + rank + '</span>' : '');
      });
      if (top5Order.length === 0) {
        top5OrderHint.textContent = 'Your order: (none yet)';
      } else {
        top5OrderHint.textContent = 'Your order: ' + top5Order.map((n, i) => (i + 1) + '. ' + n).join(', ');
      }
    }

    function updateTop5Pool() {
      const self = nameInput.value;
      top5Pool.innerHTML = '';
      top5OrderHint.textContent = self ? 'Your order: (none yet)' : 'Select your name above first.';
      if (!self) return;
      const others = PEOPLE.filter(p => p !== self);
      others.forEach(name => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-option';
        btn.dataset.name = name;
        btn.textContent = name;
        btn.addEventListener('click', () => {
          const idx = top5Order.indexOf(name);
          if (idx >= 0) {
            top5Order.splice(idx, 1);
          } else if (top5Order.length < 5) {
            top5Order.push(name);
          }
          refreshTop5Buttons();
        });
        top5Pool.appendChild(btn);
      });
      refreshTop5Buttons();
    }

    nameInput.addEventListener('input', () => { top5Order = []; updateTop5Pool(); });

    // 4. Conflicts (checkboxes as toggle buttons)
    const conflictGrid = document.getElementById('conflictGrid');
    const conflictSelected = new Set();

    function updateConflictGrid() {
      const self = nameInput.value;
      if (!self) return;
      conflictGrid.innerHTML = '';
      PEOPLE.filter(p => p !== self).forEach(name => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-option' + (conflictSelected.has(name) ? ' selected' : '');
        btn.textContent = name;
        btn.addEventListener('click', () => {
          if (conflictSelected.has(name)) conflictSelected.delete(name);
          else conflictSelected.add(name);
          btn.classList.toggle('selected', conflictSelected.has(name));
        });
        conflictGrid.appendChild(btn);
      });
    }

    nameInput.addEventListener('input', () => { conflictSelected.clear(); updateConflictGrid(); });

    // Submit
    document.getElementById('survey').addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = nameInput.value;
      if (!name) { alert('Please select your name.'); return; }

      const prefer6 = +document.getElementById('prefer6').value;
      const prefer4 = +document.getElementById('prefer4').value;
      const top5 = top5Order.slice(0, 5);
      const conflicts = Array.from(conflictSelected);

      const response = {
        [name]: {
          prefer_6_strength: prefer6,
          prefer_4_strength: prefer4,
          top5_suitemates: top5,
          conflicts: conflicts
        }
      };

      const jsonStr = JSON.stringify(response, null, 2);
      document.getElementById('jsonOut').textContent = jsonStr;
      document.getElementById('result').classList.add('show');
      document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
      window._lastJson = jsonStr;
      window._lastName = name;

      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        const row = {
          respondent_name: name,
          prefer_6_strength: prefer6,
          prefer_4_strength: prefer4,
          top5_suitemates: top5,
          conflicts: conflicts
        };
        try {
          const res = await fetch(SUPABASE_URL + '/rest/v1/survey_responses?on_conflict=respondent_name', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
              'Prefer': 'resolution=merge-duplicates'
            },
            body: JSON.stringify(row)
          });
          if (!res.ok) {
            const err = await res.text();
            console.warn('Supabase save failed:', err);
          }
        } catch (err) {
          console.warn('Supabase save failed:', err);
        }
      }
    });

    document.getElementById('copyBtn').addEventListener('click', function() {
      navigator.clipboard.writeText(window._lastJson || '').then(() => {
        this.textContent = 'Copied!';
        setTimeout(() => { this.textContent = 'Copy to clipboard'; }, 2000);
      });
    });

    document.getElementById('downloadBtn').addEventListener('click', function() {
      const name = (window._lastName || 'response').replace(/\s+/g, '_');
      const blob = new Blob([window._lastJson || '{}'], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name + '_survey_response.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
